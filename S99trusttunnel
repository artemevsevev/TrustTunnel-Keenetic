#!/bin/sh

ENABLED=yes
PROCS=trusttunnel_client
ARGS="-c /opt/trusttunnel_client/trusttunnel_client.toml"
PREARGS=""
DESC="TrustTunnel VPN Client"
PATH=/opt/sbin:/opt/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

CLIENT_BIN="/opt/trusttunnel_client/trusttunnel_client"
CONFIG_FILE="/opt/trusttunnel_client/trusttunnel_client.toml"
PID_FILE="/opt/var/run/trusttunnel.pid"
LOG_FILE="/opt/var/log/trusttunnel.log"
WATCHDOG_PID_FILE="/opt/var/run/trusttunnel_watchdog.pid"

LOG_TAG="TrustTunnel"

[ "$ENABLED" != "yes" ] && exit 0

log_info() {
    logger -t "$LOG_TAG" "$1"
}

log_error() {
    logger -p err -t "$LOG_TAG" "$1"
}

check_prereq() {
    if [ ! -x "$CLIENT_BIN" ]; then
        log_error "$CLIENT_BIN not found or not executable"
        exit 1
    fi
    if [ ! -f "$CONFIG_FILE" ]; then
        log_error "$CONFIG_FILE not found"
        exit 1
    fi
}

get_pid() {
    if [ -f "$PID_FILE" ]; then
        pid=$(cat "$PID_FILE" 2>/dev/null)
        if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
            echo "$pid"
            return 0
        fi
    fi

    pid=$(pidof "$PROCS" 2>/dev/null | awk '{print $1}')
    if [ -n "$pid" ]; then
        echo "$pid"
        return 0
    fi
    return 1
}

is_running() {
    pid=$(get_pid)
    [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null
}

watchdog() {
    echo $$ > "$WATCHDOG_PID_FILE"

    while true; do
        if ! is_running; then
            log_info "Client not running, starting..."
            start_client
        fi
        sleep 10
    done
}

start_client() {
    if is_running; then
        log_info "$DESC is already running (PID: $(get_pid))"
        return 1
    fi

    log_info "Starting $DESC..."

    $CLIENT_BIN $ARGS >> "$LOG_FILE" 2>&1 &
    pid=$!
    echo "$pid" > "$PID_FILE"

    sleep 2

    if is_running; then
        log_info "$DESC started (PID: $pid)"
        return 0
    else
        log_error "Failed to start $DESC"
        rm -f "$PID_FILE"
        return 1
    fi
}

stop_watchdog() {
    if [ -f "$WATCHDOG_PID_FILE" ]; then
        wpid=$(cat "$WATCHDOG_PID_FILE" 2>/dev/null)
        if [ -n "$wpid" ] && kill -0 "$wpid" 2>/dev/null; then
            kill "$wpid" 2>/dev/null
            sleep 1
            kill -9 "$wpid" 2>/dev/null
        fi
        rm -f "$WATCHDOG_PID_FILE"
    fi

    pkill -f "S99trusttunnel watchdog" 2>/dev/null
}

start() {
    check_prereq

    if [ -f "$WATCHDOG_PID_FILE" ]; then
        wpid=$(cat "$WATCHDOG_PID_FILE" 2>/dev/null)
        if [ -n "$wpid" ] && kill -0 "$wpid" 2>/dev/null; then
            log_info "$DESC watchdog is already running"
            return 1
        fi
    fi

    start_client

    log_info "Starting watchdog..."
    $0 watchdog &
    disown 2>/dev/null

    log_info "$DESC with watchdog started"
}

stop() {
    log_info "Stopping $DESC..."

    stop_watchdog

    pid=$(get_pid)
    if [ -n "$pid" ]; then
        kill "$pid" 2>/dev/null

        for i in 1 2 3 4 5; do
            if ! kill -0 "$pid" 2>/dev/null; then
                break
            fi
            sleep 1
        done

        if kill -0 "$pid" 2>/dev/null; then
            kill -9 "$pid" 2>/dev/null
        fi

        rm -f "$PID_FILE"
        log_info "$DESC stopped"
    else
        log_info "$DESC is not running"
    fi
}

restart() {
    stop
    sleep 2
    start
}

reload() {
    log_info "Reloading $DESC..."

    pid=$(get_pid)
    if [ -n "$pid" ]; then
        kill "$pid" 2>/dev/null
        rm -f "$PID_FILE"
        sleep 2
    fi

    log_info "Client will be restarted by watchdog"
}

status() {
    if is_running; then
        log_info "$DESC is running (PID: $(get_pid))"

        if [ -f "$WATCHDOG_PID_FILE" ]; then
            wpid=$(cat "$WATCHDOG_PID_FILE" 2>/dev/null)
            if [ -n "$wpid" ] && kill -0 "$wpid" 2>/dev/null; then
                log_info "Watchdog is running (PID: $wpid)"
            else
                log_info "Watchdog is NOT running"
            fi
        else
            log_info "Watchdog is NOT running"
        fi
        return 0
    else
        log_info "$DESC is not running"
        return 1
    fi
}

case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        restart
        ;;
    reload)
        reload
        ;;
    status)
        status
        ;;
    check)
        if ! is_running; then
            log_info "WAN reconnect detected, restarting client"
            reload
        fi
        ;;
    watchdog)
        watchdog
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|reload|status|check}"
        exit 1
        ;;
esac

exit 0
